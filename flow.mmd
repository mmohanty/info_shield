flowchart TD
    A1[/"Incoming Request: /scan, /scan-base64"/]

    %% Rule selection
    A1 --> B1["Select Rules (Regex, Keywords, NLP)"]

    %% Preprocessing
    B1 --> P1["Apply Preprocessors (Normalize, Lowercase, Strip ZWSP, etc.)"]

    %% Scanners
    P1 --> S2[_scan_regex]
    P1 --> S3[_scan_keywords]
    P1 --> S4[_scan_nlp]

    %% Validators
    S2 --> V1[Validators]
    S3 --> V1
    S4 --> V1

    %% Validation filter
    V1 -->|Valid| R1[Collect Results]
    V1 -->|Invalid| D1[Discard]

    %% Optional Redaction
    R1 --> Red[Optional Redactor]

    %% Final Response
    Red --> Out1["ScanResponse (matches, redacted, counts, used_rules)"]
